import { NextResponse } from "next/server";
import { auth } from "@/auth";
import { supabase } from "@/lib/supabase";
import { GoogleGenerativeAI } from "@google/generative-ai";

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_API_KEY || process.env.GEMINI_API_KEY || "");

export async function GET() {
    try {
        // Authenticate user
        const session = await auth();
        if (!session || !session.user || !session.user.email) {
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        const userEmail = session.user.email;
        const today = new Date().toLocaleDateString("en-CA", { timeZone: "Asia/Seoul" });

        console.log(`[daily-briefing/get] Fetching briefing for ${userEmail} on ${today}`);

        // Fetch pre-generated briefing from Supabase
        const { data, error } = await supabase
            .from('daily_briefings')
            .select('briefing_data, created_at')
            .eq('email', userEmail)
            .eq('date', today)
            .single();

        if (error && error.code !== 'PGRST116') {
            console.error('[daily-briefing/get] Error fetching briefing:', error);
            return NextResponse.json({ error: 'Failed to fetch briefing' }, { status: 500 });
        }

        // If briefing exists, return it immediately
        if (data) {
            console.log(`[daily-briefing/get] Found pre-generated briefing for ${userEmail}`);
            return NextResponse.json({
                briefing: data.briefing_data,
                generated_at: data.created_at
            });
        }

        // No pre-generated briefing found
        // DO NOT generate on-demand - return a default message instead
        console.log(`[daily-briefing/get] No pre-generated briefing found for ${userEmail} on ${today}`);
        console.log(`[daily-briefing/get] Returning default message. Briefing should be generated by cron job at 5:00 AM KST`);

        // Return a friendly default briefing
        const defaultBriefing = {
            greeting: "ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”! ğŸŒ…",
            yesterdayReview: "ì˜¤ëŠ˜ì˜ ë¸Œë¦¬í•‘ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”!",
            yesterdayStats: {
                wakeUp: false,
                learning: 0,
                trendBriefing: 0
            },
            trendSummary: [
                "ì˜¤ëŠ˜ì˜ íŠ¸ë Œë“œ ë¸Œë¦¬í•‘ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.",
                "ë§¤ì¼ ì•„ì¹¨ 5ì‹œì— ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.",
                "ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!",
                "ê³§ ë§ì¶¤í˜• ë‰´ìŠ¤ë¥¼ ë°›ì•„ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                "í”„ë¡œí•„ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.",
                "ë” ë‚˜ì€ ë¸Œë¦¬í•‘ì„ ìœ„í•´ ê´€ì‹¬ì‚¬ë¥¼ ì—…ë°ì´íŠ¸í•´ë³´ì„¸ìš”."
            ],
            todayFocus: "ë¸Œë¦¬í•‘ì´ ì¤€ë¹„ë˜ëŠ” ë™ì•ˆ ì˜¤ëŠ˜ì˜ ëª©í‘œë¥¼ ì„¤ì •í•´ë³´ì„¸ìš”!",
            importantSchedule: {
                time: "09:00",
                title: "ë¸Œë¦¬í•‘ ë‹¤ì‹œ í™•ì¸í•˜ê¸°",
                type: "reminder"
            },
            closing: "ê³§ ë§Œë‚˜ìš”! ğŸš€"
        };

        return NextResponse.json({
            briefing: defaultBriefing,
            generated_at: new Date().toISOString(),
            is_default: true,
            message: "Briefing not yet generated. Please check back in a few minutes or ensure cron job is configured."
        });

    } catch (error) {
        console.error('[daily-briefing/get] Unexpected error:', error);
        return NextResponse.json({
            error: 'Failed to fetch briefing',
            details: error instanceof Error ? error.message : 'Unknown error'
        }, { status: 500 });
    }
}
