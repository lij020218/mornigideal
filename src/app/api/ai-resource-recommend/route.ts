import { NextRequest, NextResponse } from "next/server";
import { auth } from "@/auth";
import OpenAI from "openai";
import { getUserByEmail } from "@/lib/users";
import { logOpenAIUsage } from "@/lib/openai-usage";

const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
});

interface UserProfileData {
    userType?: string;
    major?: string;
    field?: string;
    experience?: string;
    goal?: string;
    interests?: string[];
    job?: string;
    level?: string;
}

export async function POST(request: NextRequest) {
    try {
        console.log("[AI Resource Recommend] API í˜¸ì¶œ ì‹œì‘");

        // Check authentication
        const session = await auth();
        if (!session?.user?.email) {
            console.error("[AI Resource Recommend] Unauthorized access attempt");
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        const { activity, category, context, timeUntil, activityName, userProfile: providedProfile } = await request.json();
        console.log("[AI Resource Recommend] ìš”ì²­ ë°ì´í„°:", { activity, category, context, timeUntil, activityName });

        // activityName is used for schedule_start context
        const targetActivity = activityName || activity;

        if (!targetActivity) {
            return NextResponse.json(
                { error: "Activity is required" },
                { status: 400 }
            );
        }

        // Get user profile from database if not provided
        let userProfile: UserProfileData = providedProfile || {};
        if (!providedProfile || Object.keys(providedProfile).length === 0) {
            try {
                const user = await getUserByEmail(session.user.email);
                if (user?.profile) {
                    userProfile = user.profile as UserProfileData;
                    console.log("[AI Resource Recommend] DBì—ì„œ í”„ë¡œí•„ ë¡œë“œ:", userProfile);
                }
            } catch (error) {
                console.error("[AI Resource Recommend] í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:", error);
            }
        }

        // Build user context with enhanced profile data
        const interestMap: Record<string, string> = {
            ai: "AI/ì¸ê³µì§€ëŠ¥",
            startup: "ìŠ¤íƒ€íŠ¸ì—…/ì°½ì—…",
            marketing: "ë§ˆì¼€íŒ…/ë¸Œëœë”©",
            development: "ê°œë°œ/í”„ë¡œê·¸ë˜ë°",
            design: "ë””ìì¸/UX",
            finance: "ì¬í…Œí¬/íˆ¬ì",
            selfdev: "ìê¸°ê³„ë°œ",
            health: "ê±´ê°•/ìš´ë™",
        };

        const experienceMap: Record<string, string> = {
            student: "í•™ìƒ/ì·¨ì¤€ìƒ",
            junior: "1-3ë…„ì°¨",
            mid: "4-7ë…„ì°¨",
            senior: "8ë…„ì°¨ ì´ìƒ",
            beginner: "ì…ë¬¸ì",
            intermediate: "ì¤‘ê¸‰ì",
        };

        const interestLabels = (userProfile.interests || []).map(i => interestMap[i] || i);
        const experienceLabel = experienceMap[userProfile.experience || userProfile.level || ""] || userProfile.experience || userProfile.level || "ë¯¸ì„¤ì •";

        let userContext = "";
        if (userProfile && Object.keys(userProfile).length > 0) {
            userContext = `
ì‚¬ìš©ì ì •ë³´:
- ì§ì—…/ë¶„ì•¼: ${userProfile.job || userProfile.field || 'ë¯¸ì„¤ì •'}
- ê²½ë ¥: ${experienceLabel}
- ëª©í‘œ: ${userProfile.goal || 'ë¯¸ì„¤ì •'}
- ê´€ì‹¬ì‚¬: ${interestLabels.join(', ') || 'ë¯¸ì„¤ì •'}
${userProfile.major ? `- ì „ê³µ: ${userProfile.major}` : ''}
`;
        }

        // Get current context for personalized messages
        const now = new Date();
        const hour = now.getHours();
        const currentSeason = now.getMonth() >= 11 || now.getMonth() <= 1 ? "ê²¨ìš¸" :
            now.getMonth() >= 2 && now.getMonth() <= 4 ? "ë´„" :
                now.getMonth() >= 5 && now.getMonth() <= 7 ? "ì—¬ë¦„" : "ê°€ì„";
        const timeOfDay = hour < 12 ? "ì˜¤ì „" : hour < 18 ? "ì˜¤í›„" : "ì €ë…";

        // Generate different prompts based on context
        let prompt = "";

        if (context === "upcoming_schedule") {
            // ë‹¤ê°€ì˜¤ëŠ” ì¼ì •ì— ëŒ€í•œ ì¤€ë¹„ ì¡°ì–¸
            prompt = `${userContext}
ì‚¬ìš©ìì˜ ë‹¤ìŒ ì¼ì •ì¸ "${targetActivity}"ê¹Œì§€ ${timeUntil}ë¶„ ë‚¨ì•˜ìŠµë‹ˆë‹¤.
ì „ë¬¸ AI ë¹„ì„œë¡œì„œ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ê³ ë ¤í•˜ì—¬ 2-3ë¬¸ì¥ì˜ ê°„ê²°í•˜ê³  êµ¬ì²´ì ì¸ ì¤€ë¹„ íŒì„ ì œê³µí•˜ì„¸ìš”. ì¡´ëŒ“ë§ê³¼ ì´ëª¨ì§€ 1ê°œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
ì˜ˆ: "ì˜í™” ê°ìƒ ì „ íŒì½˜ê³¼ ìŒë£Œë¥¼ ì¤€ë¹„í•˜ê³  ì¡°ëª…ì„ ì–´ë‘¡ê²Œ ì¡°ì ˆí•´ë³´ì„¸ìš” ğŸ¿ ì•Œë¦¼ì„ ë„ë©´ ë” ëª°ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."`;
        } else if (context === "schedule_pre_reminder") {
            // ì¼ì • ì‹œì‘ 10ë¶„ ì „ ì‚¬ì „ ì•Œë¦¼
            prompt = `${userContext}
ê³§ ì‚¬ìš©ìì˜ "${targetActivity}" ì¼ì •ì´ ì‹œì‘ë©ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ í”„ë¡œí•„ì„ ê³ ë ¤í•˜ì—¬, ì´ ì¼ì •ê³¼ ê´€ë ¨í•˜ì—¬ ì¤€ë¹„í•˜ê±°ë‚˜ ê²°ì •í•´ì•¼ í•  ì‚¬í•­ì„ ë¬»ëŠ” ë”°ëœ»í•˜ê³  êµ¬ì²´ì ì¸ ì§ˆë¬¸ì„ 1-2ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ì„¸ìš”.
ì˜ˆ: (ì˜í™” ê°ìƒ) "ì–´ë–¤ ì˜í™”ë¥¼ ë³´ì‹¤ì§€ ê²°ì •í•˜ì…¨ë‚˜ìš”? ê¸°ë¶„ì— ë§ëŠ” ì˜í™”ë¥¼ ì¶”ì²œí•´ë“œë¦´ê¹Œìš”?"
ì˜ˆ: (íšŒì˜) "íšŒì˜ ìë£ŒëŠ” ëª¨ë‘ ì¤€ë¹„ë˜ì…¨ë‚˜ìš”? ë¯¸ë¦¬ í™•ì¸í•  ì‚¬í•­ì´ ìˆë‹¤ë©´ ë§ì”€í•´ì£¼ì„¸ìš”."
ì˜ˆ: (ë…ì„œ, ëª©í‘œê°€ 'ì˜ì–´ ê³µë¶€') "ì˜¤ëŠ˜ì€ ì˜ì–´ ì›ì„œë¥¼ ì½ì–´ë³´ì‹œëŠ” ê±´ ì–´ë– ì„¸ìš”? ì¶”ì²œí•´ë“œë¦´ê¹Œìš”?"`;
        } else if (context === "schedule_completed") {
            // ì¼ì • ì¢…ë£Œ í›„ ë§ì¶¤í˜• í”¼ë“œë°± ìš”ì²­
            prompt = `${userContext}
ì‚¬ìš©ìê°€ "${targetActivity}" ì¼ì •ì„ ë§ˆì³¤ìŠµë‹ˆë‹¤.

**ì—­í• **: ì‚¬ìš©ì ì§ì—…("${userProfile?.job || userProfile?.field || 'ì „ë¬¸ì§'}")ì„ ì´í•´í•˜ëŠ” ì „ë¬¸ ë¹„ì„œ

**í•µì‹¬ ì§€ì¹¨**:
1. "${targetActivity}"ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ë¼ê³  ìì—°ìŠ¤ëŸ½ê²Œ ë¬¼ì–´ë³´ì„¸ìš”
2. í•´ë‹¹ **ì§ì—…ì— íŠ¹í™”ëœ** í›„ì† ì§ˆë¬¸ 2-3ê°œë¥¼ ë¦¬ìŠ¤íŠ¸(â€¢)ë¡œ ì œì•ˆí•˜ì„¸ìš”
3. í™œë™ì„ **ì‹œì‘í•˜ê¸° ì „** ê±´ë„¬ ë§ì´ ì•„ë‹ˆë¼, **ëë‚œ í›„** íšŒê³ /ì •ë¦¬ì— ì´ˆì ì„ ë§ì¶”ì„¸ìš”
4. ì¡´ëŒ“ë§ê³¼ ì´ëª¨ì§€ 1ê°œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”

**ì§ì—…ë³„ ì¢‹ì€ ì˜ˆì‹œ**:

- (íšŒê³„ì‚¬ + ì—…ë¬´) "ì—…ë¬´ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ğŸ“Š
â€¢ ì˜¤ëŠ˜ ì²˜ë¦¬í•œ ì „í‘œë‚˜ ì„¸ë¬´ ì—…ë¬´ë¥¼ ì •ë¦¬í•´ë“œë¦´ê¹Œìš”?
â€¢ ë‚´ì¼ ë§ˆê°ì¸ ì‹ ê³  ê±´ì´ ìˆë‚˜ìš”?
â€¢ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬í•  ê²€í†  ì‚¬í•­ì´ ìˆë‚˜ìš”?"

- (ê°œë°œì + ì—…ë¬´) "ê°œë°œ ì—…ë¬´ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ğŸ’»
â€¢ ì˜¤ëŠ˜ ì»¤ë°‹í•œ ë‚´ìš©ì„ ì •ë¦¬í•´ë“œë¦´ê¹Œìš”?
â€¢ ì½”ë“œ ë¦¬ë·°ê°€ í•„ìš”í•œ PRì´ ìˆë‚˜ìš”?
â€¢ ë‚´ì¼ ì´ì–´ì„œ ì‘ì—…í•  ì´ìŠˆê°€ ìˆë‚˜ìš”?"

- (ë§ˆì¼€í„° + ì—…ë¬´) "ë§ˆì¼€íŒ… ì—…ë¬´ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ğŸ“ˆ
â€¢ ì˜¤ëŠ˜ ìº í˜ì¸ ì„±ê³¼ ë°ì´í„°ë¥¼ ì •ë¦¬í•´ë“œë¦´ê¹Œìš”?
â€¢ ë‹¤ìŒ ì£¼ ì½˜í…ì¸  ì¼ì •ì„ í™•ì¸í•´ë³¼ê¹Œìš”?
â€¢ A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë¶„ì„í•´ë“œë¦´ê¹Œìš”?"

- (ë””ìì´ë„ˆ + ì—…ë¬´) "ë””ìì¸ ì‘ì—…ì€ ì–´ë– ì…¨ë‚˜ìš”? ğŸ¨
â€¢ ì˜¤ëŠ˜ ì‘ì—…í•œ ë””ìì¸ì„ ì •ë¦¬í•´ë“œë¦´ê¹Œìš”?
â€¢ í”¼ë“œë°± ë°›ì„ ì¤€ë¹„ê°€ ëœ ì‹œì•ˆì´ ìˆë‚˜ìš”?
â€¢ ë‚´ì¼ í•¸ë“œì˜¤í”„ ì˜ˆì •ì¸ ì‘ì—…ì´ ìˆë‚˜ìš”?"

- (ì˜ì—… + ì—…ë¬´) "ì˜ì—… í™œë™ì€ ì–´ë– ì…¨ë‚˜ìš”? ğŸ“
â€¢ ì˜¤ëŠ˜ ë¯¸íŒ… ê²°ê³¼ë¥¼ CRMì— ê¸°ë¡í•´ë“œë¦´ê¹Œìš”?
â€¢ íŒ”ë¡œì—…ì´ í•„ìš”í•œ ê³ ê°ì´ ìˆë‚˜ìš”?
â€¢ ë‹¤ìŒ ì£¼ íŒŒì´í”„ë¼ì¸ì„ ì •ë¦¬í•´ë³¼ê¹Œìš”?"

**ì¼ë°˜ í™œë™ ì˜ˆì‹œ**:
- (ê³µë¶€) "ê³µë¶€ëŠ” ì–´ë– ì…¨ë‚˜ìš”? ğŸ“š
â€¢ ì˜¤ëŠ˜ ë°°ìš´ ë‚´ìš©ì„ ê°„ë‹¨íˆ ìš”ì•½í•´ë“œë¦´ê¹Œìš”?
â€¢ ì´í•´ê°€ ì•ˆ ë˜ëŠ” ë¶€ë¶„ì´ ìˆì—ˆë‚˜ìš”?"

- (ìš´ë™) "ìš´ë™ì€ ì–´ë– ì…¨ë‚˜ìš”? ğŸ’ª
â€¢ ì˜¤ëŠ˜ ìš´ë™ ê¸°ë¡ì„ ë‚¨ê²¨ë“œë¦´ê¹Œìš”?
â€¢ ìŠ¤íŠ¸ë ˆì¹­ì€ ì¶©ë¶„íˆ í•˜ì…¨ë‚˜ìš”?"

**ë‚˜ìœ ì˜ˆì‹œ** (ì‹œì‘ ì „ ë§íˆ¬ë¼ì„œ ë¶€ì ì ˆ):
âŒ "ì–´ë–¤ ì˜í™”ë¥¼ ë³´ì‹¤ì§€ ê²°ì •í•˜ì…¨ë‚˜ìš”?"
âŒ "íšŒì˜ ìë£ŒëŠ” ëª¨ë‘ ì¤€ë¹„ë˜ì…¨ë‚˜ìš”?"

**ì¤‘ìš”**: ì‚¬ìš©ìì˜ ì§ì—…ì— ë§ëŠ” **ì‹¤ë¬´ì ì¸ í›„ì† ì§ˆë¬¸**ì„ í•˜ì„¸ìš”. ì¼ë°˜ì ì¸ ì§ˆë¬¸ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.`;
        } else if (context === "in_progress") {
            // T+30ë¶„: ì—…ë¬´ ì§„í–‰ ì¤‘ ì¸ì‚¬ì´íŠ¸ ì œê³µ
            prompt = `${userContext}
ì‚¬ìš©ìê°€ "${targetActivity}" í™œë™ì„ ì‹œì‘í•œ ì§€ 30ë¶„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤.

**ì—­í• : í•´ë‹¹ ì§ì—… ë¶„ì•¼ì˜ ì „ë¬¸ ë©˜í† **
ì‚¬ìš©ìì˜ ì§ì—…("${userProfile?.job || userProfile?.field || 'ì „ë¬¸ì§'}")ì— **ì‹¤ì œë¡œ ë„ì›€ì´ ë˜ëŠ” ì—…ë¬´ ê´€ë ¨ ì •ë³´**ë¥¼ ì œê³µí•˜ì„¸ìš”.

**í•µì‹¬ ì›ì¹™:**
1. **ì§ì—… íŠ¹í™” ì •ë³´**: í•´ë‹¹ ì§ì—…ì—ì„œ ì‹¤ì œë¡œ ì‚¬ìš©í•˜ëŠ” ë„êµ¬, ìë£Œ, ìµœì‹  ë™í–¥ì„ ì–¸ê¸‰
2. **ì‹¤ë¬´ì— ë°”ë¡œ ì ìš© ê°€ëŠ¥**: ì¼ë°˜ì ì¸ ì¡°ì–¸ì´ ì•„ë‹Œ, ì§€ê¸ˆ ì—…ë¬´ì— ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” êµ¬ì²´ì  íŒ
3. **ì—…ê³„ ìš©ì–´ ì‚¬ìš©**: í•´ë‹¹ ë¶„ì•¼ ì¢…ì‚¬ìë¼ë©´ ë°”ë¡œ ì´í•´í•  ìˆ˜ ìˆëŠ” ì „ë¬¸ ìš©ì–´ í¬í•¨
4. **ê°„ê²°í•¨**: 2-3ë¬¸ì¥

**ì§ì—…ë³„ ì¢‹ì€ ì˜ˆì‹œ:**

- (íšŒê³„ì‚¬) "ì´ë²ˆ ë‹¬ ë¶€ê°€ì„¸ ì‹ ê³  ë§ˆê°ì´ ë‹¤ê°€ì˜¤ê³  ìˆì–´ìš” ğŸ“Š êµ­ì„¸ì²­ í™ˆíƒìŠ¤ì—ì„œ ì „ìì„¸ê¸ˆê³„ì‚°ì„œ í•©ê³„í‘œë¥¼ ë¯¸ë¦¬ í™•ì¸í•´ë³´ì‹œëŠ” ê±´ ì–´ë–¨ê¹Œìš”? ìµœê·¼ ê°œì •ëœ ë²•ì¸ì„¸ë²• ì‹œí–‰ë ¹ë„ ì°¸ê³ í•˜ì‹œë©´ ì¢‹ê² ìŠµë‹ˆë‹¤."

- (ê°œë°œì) "ì½”ë“œ ë¦¬ë·° ì‹œê°„ì´ë¼ë©´, GitHub Copilotì˜ ìµœì‹  ê¸°ëŠ¥ìœ¼ë¡œ ë¦¬íŒ©í† ë§ ì œì•ˆì„ ë°›ì•„ë³´ì„¸ìš” ğŸ’» ì˜¤ëŠ˜ ë°œí‘œëœ Node.js 22 LTS ì—…ë°ì´íŠ¸ ë‚´ìš©ë„ ì²´í¬í•´ë³´ì‹œë©´ ì¢‹ê² ìŠµë‹ˆë‹¤."

- (ë§ˆì¼€í„°) "êµ¬ê¸€ ì• ë„ë¦¬í‹±ìŠ¤ 4ì—ì„œ ì´ë²ˆ ì£¼ ì „í™˜ìœ¨ ì¶”ì´ë¥¼ í™•ì¸í•´ë³´ì„¸ìš” ğŸ“ˆ ë©”íƒ€ ê´‘ê³  ê´€ë¦¬ìì—ì„œ A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼ë„ ê°™ì´ ê²€í† í•˜ë©´ ì¸ì‚¬ì´íŠ¸ë¥¼ ì–»ì„ ìˆ˜ ìˆì–´ìš”."

- (ë””ìì´ë„ˆ) "Figmaì˜ Dev Modeë¡œ ê°œë°œíŒ€ê³¼ í•¸ë“œì˜¤í”„ ì¤€ë¹„ë¥¼ í•´ë³´ì„¸ìš” ğŸ¨ Auto Layout ì„¤ì •ì´ ì˜ ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ë©´ í˜‘ì—…ì´ ìˆ˜ì›”í•´ì§‘ë‹ˆë‹¤."

- (ë³€í˜¸ì‚¬) "ëŒ€ë²•ì› ì¢…í•©ë²•ë¥ ì •ë³´ì—ì„œ ìµœê·¼ íŒë¡€ë¥¼ ê²€ìƒ‰í•´ë³´ì„¸ìš” âš–ï¸ ì´ë²ˆ ë‹¬ ì‹œí–‰ë˜ëŠ” ê°œì • ë²•ë¥  ì¤‘ ë‹´ë‹¹ ì‚¬ê±´ê³¼ ê´€ë ¨ëœ ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸í•´ë³´ì‹œëŠ” ê±´ ì–´ë–¨ê¹Œìš”?"

- (ì˜ì‚¬/ê°„í˜¸ì‚¬) "ìµœì‹  ì˜í•™ ì €ë„(NEJM, Lancet)ì—ì„œ ê´€ë ¨ ë¶„ì•¼ ì—°êµ¬ë¥¼ ì²´í¬í•´ë³´ì„¸ìš” ğŸ¥ ì§„ë£Œ ê°€ì´ë“œë¼ì¸ ì—…ë°ì´íŠ¸ ì‚¬í•­ë„ í™•ì¸í•˜ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤."

- (êµì‚¬) "í•™ìƒ í‰ê°€ ìë£Œë¥¼ ì •ë¦¬í•˜ë©´ì„œ, ì—ë“€ë„· T-CLEARì˜ ì„±ì·¨ê¸°ì¤€ ìë£Œë¥¼ ì°¸ê³ í•´ë³´ì„¸ìš” ğŸ“ ë‹¤ìŒ ìˆ˜ì—… ìë£Œ ì¤€ë¹„ì— ë„ì›€ì´ ë  ê±°ì˜ˆìš”."

- (ì˜ì—…/ì„¸ì¼ì¦ˆ) "CRMì—ì„œ ì´ë²ˆ ì£¼ íŒ”ë¡œì—…í•´ì•¼ í•  ê³ ê° ë¦¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•´ë³´ì„¸ìš” ğŸ“ ì—…ê³„ ë™í–¥ ë‰´ìŠ¤ë„ ì²´í¬í•˜ë©´ ê³ ê° ë¯¸íŒ… ë•Œ ëŒ€í™” ì†Œì¬ê°€ ë©ë‹ˆë‹¤."

**ë‚˜ìœ ì˜ˆì‹œ:**
âŒ "ì˜ í•˜ê³  ê³„ì‹œë„¤ìš”! í™”ì´íŒ…!" (ë„ˆë¬´ ì¼ë°˜ì )
âŒ "ë½€ëª¨ë„ë¡œ ê¸°ë²•ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”" (ì§ì—…ê³¼ ë¬´ê´€í•œ ì¼ë°˜ ìƒì‚°ì„± íŒ)
âŒ "ë¬¼ í•œ ì” ë“œì‹œê³  ìŠ¤íŠ¸ë ˆì¹­ í•˜ì„¸ìš”" (ì—…ë¬´ì™€ ë¬´ê´€)

**ì¤‘ìš”**: ì‚¬ìš©ìì˜ ì§ì—…ì„ íŒŒì•…í•˜ê³ , ê·¸ ì§ì—…ì—ì„œ **ì‹¤ì œë¡œ ì‚¬ìš©í•˜ëŠ” ë„êµ¬, ì‚¬ì´íŠ¸, ìë£Œ**ë¥¼ ì–¸ê¸‰í•˜ì„¸ìš”. ì¼ë°˜ì ì¸ ìƒì‚°ì„± ì¡°ì–¸ì€ ê¸ˆì§€ì…ë‹ˆë‹¤.`;
        } else if (context === "schedule_start") {
            // ì¼ì • ì‹œì‘ ì‹œ ë¦¬ì†ŒìŠ¤ ì¶”ì²œ
            prompt = `${userContext}
"${targetActivity}" ì‹œê°„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.

**ì—­í• **: ì‚¬ìš©ì ì§ì—…("${userProfile?.job || userProfile?.field || 'ì „ë¬¸ì§'}")ì— íŠ¹í™”ëœ ì „ë¬¸ ë¹„ì„œ

**í•µì‹¬ ì›ì¹™:**
1. **ì§ì—… ë§ì¶¤ ì‹œì‘ íŒ**: í•´ë‹¹ ì§ì—…ì—ì„œ ì—…ë¬´/í™œë™ì„ ì‹œì‘í•  ë•Œ ì‹¤ì œë¡œ ë„ì›€ì´ ë˜ëŠ” êµ¬ì²´ì  ì¡°ì–¸
2. **ì‹¤ë¬´ ë„êµ¬/ìë£Œ ì–¸ê¸‰**: í•´ë‹¹ ë¶„ì•¼ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì‹¤ì œ ë„êµ¬, ì‚¬ì´íŠ¸, ìë£Œ ì¶”ì²œ
3. **ê°„ê²°í•¨**: 2-3ë¬¸ì¥, ì¡´ëŒ“ë§ê³¼ ì´ëª¨ì§€ 1ê°œ

**ì§ì—…ë³„ ì¢‹ì€ ì˜ˆì‹œ:**
- (íšŒê³„ì‚¬ + ì—…ë¬´) "ì˜¤ëŠ˜ ì²˜ë¦¬í•  ì „í‘œ ëª©ë¡ì„ ë¨¼ì € í™•ì¸í•´ë³´ì„¸ìš” ğŸ“Š ë”ì¡´ì´ë‚˜ ì„¸ë¬´ì‚¬ë‘ í”„ë¡œê·¸ë¨ì—ì„œ ë¯¸ê²° ê±´ì„ ì²´í¬í•˜ë©´ ìš°ì„ ìˆœìœ„ë¥¼ ì •í•˜ê¸° ì‰½ìŠµë‹ˆë‹¤."
- (ê°œë°œì + ì—…ë¬´) "ì˜¤ëŠ˜ì˜ Jira í‹°ì¼“ì„ í™•ì¸í•˜ê³  PR ë¦¬ë·°ë¶€í„° ì‹œì‘í•´ë³´ì„¸ìš” ğŸ’» ì•„ì¹¨ì— ì½”ë“œ ë¦¬ë·°í•˜ë©´ ì§‘ì¤‘ì´ ì˜ ë©ë‹ˆë‹¤."
- (ë§ˆì¼€í„° + ì—…ë¬´) "ì˜¤ëŠ˜ ê´‘ê³  ì„±ê³¼ ë°ì´í„°ë¶€í„° í™•ì¸í•´ë³´ì„¸ìš” ğŸ“ˆ ì–´ì œ ëŒ€ë¹„ CTR ë³€í™”ë¥¼ ì²´í¬í•˜ë©´ ì˜¤ëŠ˜ ìµœì í™” ë°©í–¥ì´ ë³´ì…ë‹ˆë‹¤."
- (ë””ìì´ë„ˆ + ì—…ë¬´) "Figmaì—ì„œ ì–´ì œ ë°›ì€ í”¼ë“œë°± ì½”ë©˜íŠ¸ë¶€í„° í™•ì¸í•´ë³´ì„¸ìš” ğŸ¨ ìˆ˜ì • ì‚¬í•­ì„ ë¨¼ì € ì²˜ë¦¬í•˜ë©´ ì˜¤í›„ì— ìƒˆ ì‘ì—…ì— ì§‘ì¤‘í•  ìˆ˜ ìˆì–´ìš”."
- (ì˜ì—… + ì—…ë¬´) "ì˜¤ëŠ˜ ë¯¸íŒ… ì˜ˆì •ì¸ ê³ ê°ì‚¬ ì •ë³´ë¥¼ CRMì—ì„œ ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš” ğŸ“ ìµœê·¼ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ íˆìŠ¤í† ë¦¬ë¥¼ íŒŒì•…í•˜ë©´ ëŒ€í™”ê°€ ìˆ˜ì›”í•´ì§‘ë‹ˆë‹¤."

**ì¼ë°˜ í™œë™ ì˜ˆì‹œ:**
- (ë…ì„œ + ëª©í‘œ: ì˜ì–´ê³µë¶€) "ì˜ì–´ ì›ì„œ ì½ê¸°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš” ğŸ“š Kindle ì•±ì˜ ë‹¨ì–´ íƒ­ ê¸°ëŠ¥ì„ í™œìš©í•˜ë©´ ëª¨ë¥´ëŠ” ë‹¨ì–´ë¥¼ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”."
- (ìš´ë™ + ë ˆë²¨: beginner) "ê°€ë²¼ìš´ ë™ì  ìŠ¤íŠ¸ë ˆì¹­ìœ¼ë¡œ ëª¸ì„ í’€ê³  ì‹œì‘í•˜ì„¸ìš” ğŸƒ ë¶€ìƒ ì˜ˆë°©ì— ì¤‘ìš”í•©ë‹ˆë‹¤."

**ì£¼ì˜**: ì‚¬ìš©ìì˜ ì§ì—…ì´ ìˆë‹¤ë©´ í•´ë‹¹ ì§ì—…ì—ì„œ ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” ë„êµ¬ì™€ ì›Œí¬í”Œë¡œìš°ë¥¼ ì–¸ê¸‰í•˜ì„¸ìš”.`;
        } else {
            // ê¸°ì¡´ ì¼ì • ì¶”ê°€ ì‹œ ë¦¬ì†ŒìŠ¤ ì¶”ì²œ (ê¸°ë³¸)
            prompt = `${userContext}
ì‚¬ìš©ìê°€ "${targetActivity}" (${category}, ${timeOfDay} ${hour}ì‹œ) ì¼ì •ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
ì „ë¬¸ AI ë¹„ì„œë¡œì„œ, ì‚¬ìš©ì ì •ë³´ë¥¼ ê³ ë ¤í•˜ì—¬ ì´ í™œë™ì„ ë°”ë¡œ ì‹œì‘í•˜ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” ì‹¤ì§ˆì ì¸ ì¡°ì–¸ì´ë‚˜ ë¦¬ì†ŒìŠ¤ë¥¼ ì œê³µí•˜ì„¸ìš”.

**ì§€ì¹¨**:
1. **ë§¥ë½ íŒŒì•…**: í™œë™ ì´ë¦„ì—ì„œ êµ¬ì²´ì ì¸ ì˜ë„ê°€ ë³´ì´ë©´(ì˜ˆ: "ì˜í™” ê°ìƒ") ê²€ìƒ‰ ë°©ë²•ë³´ë‹¤ëŠ” **ì‹¤ì œ ì½˜í…ì¸  ì¶”ì²œ**ì´ë‚˜ **ë¶„ìœ„ê¸° ì¡°ì„± íŒ**ì„ ì œê³µí•˜ì„¸ìš”.
2. **ê³¼ë„í•œ ê²€ìƒ‰ ì§€ì–‘**: ë‹¨ìˆœíˆ "ìœ íŠœë¸Œì— ~ ê²€ìƒ‰í•˜ì„¸ìš”"ë¼ê³  ë‚˜ì—´í•˜ê¸°ë³´ë‹¤, "ìœ íŠœë¸Œ 'ê¹€ì‹œì„ ' ì±„ë„ì˜ ìµœì‹  ë¦¬ë·°ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”"ì²˜ëŸ¼ êµ¬ì²´ì ìœ¼ë¡œ ì½• ì§‘ì–´ì£¼ì„¸ìš”.
3. **ê°„ê²°í•¨**: 3-5ê°œ ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í™œë™ ì„±ê²©ì— ë§ì¶° ê°€ì¥ í•„ìš”í•œ 1-2ê°€ì§€ë§Œ ì„íŒ©íŠ¸ ìˆê²Œ ì œì•ˆí•´ë„ ì¢‹ìŠµë‹ˆë‹¤.

**í•„ìˆ˜ í¬í•¨**:
- í™œë™ì„ ë” ì¦ê²ê²Œ ë§Œë“¤ "í•œ ë— ì°¨ì´" íŒ (ì˜ˆ: ì¡°ëª…, ê°„ì‹, ì¤€ë¹„ë¬¼)
- ê³ ë¯¼ ì‹œê°„ì„ ì¤„ì—¬ì¤„ êµ¬ì²´ì ì¸ ì‹œì‘ì  (ì˜ˆ: ë„·í”Œë¦­ìŠ¤ Top 10 ë°”ë¡œê°€ê¸°, íŠ¹ì • ìœ íŠœë¸Œ ì±„ë„ëª…)`;
        }

        console.log("[AI Resource Recommend] OpenAI ìš”ì²­ ì‹œì‘");
        const modelName = "gpt-5.2-2025-12-11";
        const completion = await openai.chat.completions.create({
            model: modelName,
            messages: [
                {
                    role: "system",
                    content: `ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ì§ì—…ê³¼ ë¶„ì•¼ë¥¼ ê¹Šì´ ì´í•´í•˜ëŠ” ì „ë¬¸ AI ë¹„ì„œì…ë‹ˆë‹¤.

**í•µì‹¬ ì›ì¹™:**
1. **ì§ì—… íŠ¹í™”**: ì‚¬ìš©ìì˜ ì§ì—…(íšŒê³„ì‚¬, ê°œë°œì, ë§ˆì¼€í„°, ë””ìì´ë„ˆ, ë³€í˜¸ì‚¬, ì˜ì‚¬, êµì‚¬ ë“±)ì— ë”°ë¼ í•´ë‹¹ ë¶„ì•¼ì—ì„œ ì‹¤ì œë¡œ ì‚¬ìš©í•˜ëŠ” ë„êµ¬, ì‚¬ì´íŠ¸, ìš©ì–´, ì›Œí¬í”Œë¡œìš°ë¥¼ ì–¸ê¸‰í•˜ì„¸ìš”.
2. **ì‹¤ë¬´ ì¤‘ì‹¬**: ì¼ë°˜ì ì¸ ìƒì‚°ì„± íŒ(ë½€ëª¨ë„ë¡œ, ë¬¼ ë§ˆì‹œê¸°, ìŠ¤íŠ¸ë ˆì¹­ ë“±)ì´ ì•„ë‹Œ, í•´ë‹¹ ì—…ë¬´ì— ì§ì ‘ ë„ì›€ì´ ë˜ëŠ” ì •ë³´ë§Œ ì œê³µí•˜ì„¸ìš”.
3. **ì—…ê³„ ì§€ì‹**: í•´ë‹¹ ë¶„ì•¼ì˜ ìµœì‹  ë™í–¥, ë§ˆê°ì¼(ì„¸ê¸ˆ ì‹ ê³ , ë¶„ê¸° ë§ˆê° ë“±), ìì£¼ ì‚¬ìš©í•˜ëŠ” í”Œë«í¼(í™ˆíƒìŠ¤, Jira, Figma, CRM ë“±)ì„ ì•Œê³  ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
4. **ê°„ê²°í•¨**: 2-3ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ë§Œ ì „ë‹¬í•˜ì„¸ìš”. ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ì„¸ìš”.

ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ì‚¬ìš©ìê°€ "ì´ AIê°€ ë‚´ ì§ì—…ì„ ì •ë§ ì´í•´í•˜ëŠ”êµ¬ë‚˜"ë¼ê³  ëŠë¼ê²Œ ë§Œë“œëŠ” ê²ƒì…ë‹ˆë‹¤.`
                },
                {
                    role: "user",
                    content: prompt,
                },
            ],
            temperature: 0.7,
        });

        console.log("[AI Resource Recommend] OpenAI ì‘ë‹µ ì„±ê³µ");
        const recommendation = completion.choices[0]?.message?.content || "ë¦¬ì†ŒìŠ¤ë¥¼ ì¶”ì²œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

        // Log usage
        const usage = completion.usage;
        if (usage) {
            await logOpenAIUsage(
                session.user.email,
                modelName,
                "ai-resource-recommend",
                usage.prompt_tokens,
                usage.completion_tokens
            );
        }

        return NextResponse.json({
            recommendation,
            activity: targetActivity,
            category,
            context,
        });
    } catch (error: any) {
        console.error("[AI Resource Recommend] ì—ëŸ¬ ë°œìƒ:", error);
        console.error("[AI Resource Recommend] ì—ëŸ¬ ìƒì„¸:", error.message);
        console.error("[AI Resource Recommend] ì—ëŸ¬ ìŠ¤íƒ:", error.stack);
        return NextResponse.json(
            { error: "Failed to generate resource recommendation", details: error.message },
            { status: 500 }
        );
    }
}
