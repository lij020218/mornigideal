import { NextRequest, NextResponse } from "next/server";
import { auth } from "@/auth";
import OpenAI from "openai";

const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(request: NextRequest) {
    try {
        console.log("[AI Resource Recommend] API í˜¸ì¶œ ì‹œìž‘");

        // Check authentication
        const session = await auth();
        if (!session?.user?.email) {
            console.error("[AI Resource Recommend] Unauthorized access attempt");
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        const { activity, category } = await request.json();
        console.log("[AI Resource Recommend] ìš”ì²­ ë°ì´í„°:", { activity, category });

        if (!activity) {
            return NextResponse.json(
                { error: "Activity is required" },
                { status: 400 }
            );
        }

        // Get current context for personalized messages
        const now = new Date();
        const hour = now.getHours();
        const currentSeason = now.getMonth() >= 11 || now.getMonth() <= 1 ? "ê²¨ìš¸" :
                             now.getMonth() >= 2 && now.getMonth() <= 4 ? "ë´„" :
                             now.getMonth() >= 5 && now.getMonth() <= 7 ? "ì—¬ë¦„" : "ê°€ì„";
        const timeOfDay = hour < 12 ? "ì˜¤ì „" : hour < 18 ? "ì˜¤í›„" : "ì €ë…";

        // Generate professional assistant messages with value
        const prompt = `ì‚¬ìš©ìžê°€ "${activity}" ì¼ì •ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

í˜„ìž¬ ìƒí™©:
- ì‹œê°„ëŒ€: ${timeOfDay} ${hour}ì‹œ
- ê³„ì ˆ: ${currentSeason}
- í™œë™ ì¹´í…Œê³ ë¦¬: ${category}

ì „ë¬¸ AI ë¹„ì„œë¡œì„œ ë‹¤ìŒ ì›ì¹™ì— ë”°ë¼ ë©”ì‹œì§€ë¥¼ ìž‘ì„±í•˜ì„¸ìš”:

**í•µì‹¬ ì›ì¹™**
- ì¡´ëŒ“ë§ë§Œ ì‚¬ìš© (ë°˜ë§ ì ˆëŒ€ ê¸ˆì§€)
- í•„ìš”í•œ ì •ë³´ë§Œ ì •í™•í•˜ê²Œ ì „ë‹¬
- ì‹¤ì§ˆì ì¸ ë„ì›€ì´ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ë‚˜ í–‰ë™ ì œì‹œ
- ê° í™œë™ë§ˆë‹¤ ì™„ì „ížˆ ë‹¤ë¥¸ ì ‘ê·¼ ë°©ì‹

**í™œë™ë³„ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼**

ðŸ“š **ë…ì„œ/í•™ìŠµ** - ë¦¬ì†ŒìŠ¤ ì œê³µ ì¤‘ì‹¬
"[í™œë™] ì¼ì •ì„ ì¶”ê°€í•˜ì…¨ë„¤ìš”. [êµ¬ì²´ì  ë¦¬ì†ŒìŠ¤ 1-2ê°œ: êµë³´ë¬¸ê³ /YES24/ì•Œë¼ë”˜/ì¸ê°• í”Œëž«í¼]. [ì¶”ê°€ ì§€ì› ì œì•ˆ ì§ˆë¬¸]"
ì˜ˆ: "ë…ì„œ ì‹œê°„ì´ì‹œë„¤ìš” ðŸ“š êµë³´ë¬¸ê³ ë‚˜ YES24ì—ì„œ 'ë¦° ìŠ¤íƒ€íŠ¸ì—…'ì„ ê²€ìƒ‰í•˜ì‹œë©´ MVP ê°œë…ì„ ìž˜ ì„¤ëª…í•œ ì±…ì„ ì°¾ìœ¼ì‹¤ ìˆ˜ ìžˆì–´ìš”. ë‹¤ë¥¸ ì¶”ì²œ ë„ì„œê°€ í•„ìš”í•˜ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”."

ðŸ’¼ **íšŒì˜/ì—…ë¬´** - ì¤€ë¹„ ì²´í¬ + ì§€ì›
"[íšŒì˜/ì—…ë¬´] ì¤€ë¹„ ì‹œê°„ìž…ë‹ˆë‹¤. [í•µì‹¬ ì²´í¬í¬ì¸íŠ¸]. [ìžë£Œ ì§€ì› ì œì•ˆ]"
ì˜ˆ: "íšŒì˜ ì¤€ë¹„ ì‹œê°„ìž…ë‹ˆë‹¤. ë°œí‘œ ìžë£Œì™€ ì°¸ê³  ë¬¸ì„œ ìž¬ì ê²€í•˜ì…¨ë‚˜ìš”? íšŒì˜ ì£¼ì œ ê´€ë ¨ ì¶”ê°€ ìžë£Œê°€ í•„ìš”í•˜ì‹œë©´ êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ì•Œë ¤ì£¼ì„¸ìš”."

ðŸš€ **í”„ë¡œì íŠ¸/ì½”ë”©** - ì‹¤ìš© ë¦¬ì†ŒìŠ¤ + ì¡°ì–¸
"[í”„ë¡œì íŠ¸] ìž‘ì—… ì‹œìž‘ì´ì‹œêµ°ìš”. [êµ¬ì²´ì  ë¦¬ì†ŒìŠ¤/ê²€ìƒ‰ì–´]. [í•µì‹¬ ì¡°ì–¸ 1ê°€ì§€]"
ì˜ˆ: "AI MVP ìž‘ì—…ì´ì‹œêµ°ìš”. GitHubì—ì„œ 'ai mvp boilerplate'ë‚˜ 'fastapi langchain'ìœ¼ë¡œ ê²€ìƒ‰í•˜ì‹œë©´ ì°¸ê³ í•  í…œí”Œë¦¿ë“¤ì´ ë§Žì•„ìš”. í•µì‹¬ ê¸°ëŠ¥ í•˜ë‚˜ë§Œ ë¨¼ì € ì™„ì„±í•˜ì‹œê³  í™•ìž¥í•˜ì‹œê¸¸ ì¶”ì²œë“œë ¤ìš”."

ðŸ’ª **ìš´ë™** - ì‹¤ìš© íŒ + ë¦¬ì†ŒìŠ¤
"[ìš´ë™] ì‹œê°„ìž…ë‹ˆë‹¤! [ê³„ì ˆ/ë‚ ì”¨ ê³ ë ¤ íŒ]. [ìœ íŠœë¸Œ/ì•± ì¶”ì²œ]"
ì˜ˆ: "ìš´ë™ ì‹œê°„ìž…ë‹ˆë‹¤ ðŸ’ª ê²¨ìš¸ì´ë‹ˆ ì¶©ë¶„ížˆ ì›Œë°ì—…í•˜ì„¸ìš”. ìœ íŠœë¸Œì—ì„œ 'ì´ˆë³´ í™ˆíŠ¸ë ˆì´ë‹'ì„ ê²€ìƒ‰í•˜ì‹œë©´ ë”°ë¼í•˜ê¸° ì¢‹ì€ ë£¨í‹´ì„ ì°¾ìœ¼ì‹¤ ìˆ˜ ìžˆì–´ìš”."

â˜• **íœ´ì‹/ì‚¬êµ** - ìž¥ì†Œ/í™˜ê²½ ì œì•ˆ ì¤‘ì‹¬
"[í™œë™]ì´ì‹œêµ°ìš”. [ìž¥ì†Œ/í™˜ê²½ ì°¾ê¸° íŒ]. [ì‹¤ìš© ì§ˆë¬¸/ì œì•ˆ]"
ì˜ˆ: "ì»¤í”¼ì±— ì‹œê°„ì´ì‹œë„¤ìš” â˜• ë„¤ì´ë²„ ì§€ë„ì—ì„œ 'ì¡°ìš©í•œ ì¹´íŽ˜'ë¡œ ê²€ìƒ‰í•˜ì‹œë©´ ëŒ€í™”í•˜ê¸° ì¢‹ì€ ê³³ë“¤ì´ ë‚˜ì™€ìš”. ë¯¸ë¦¬ ëŒ€í™” ì£¼ì œë¥¼ ì •í•´ë‘ì‹œë©´ ë” ì•Œì°¬ ì‹œê°„ì´ ë  ê±°ì˜ˆìš”."

ðŸ½ï¸ **ì‹ì‚¬** - ë©”ë‰´ ì œì•ˆ + ìž¥ì†Œ
"[ì‹ì‚¬] ì‹œê°„ì´ì—ìš”. [ì‹œê°„ëŒ€/ê³„ì ˆ ê³ ë ¤ ë©”ë‰´ ì¶”ì²œ]. [ë§›ì§‘ ì°¾ê¸° íŒ]"
ì˜ˆ: "ì ì‹¬ ì‹ì‚¬ ì‹œê°„ì´ì—ìš” ðŸ½ï¸ ì˜¤í›„ì—ëŠ” ë‹¨ë°±ì§ˆì´ í’ë¶€í•œ ë©”ë‰´ê°€ ì¢‹ì•„ìš”. ë„¤ì´ë²„ ì§€ë„ì—ì„œ 'ì£¼ë³€ ìƒëŸ¬ë“œ ë³¼'ì´ë‚˜ 'ë‹­ê°€ìŠ´ì‚´ ë„ì‹œë½'ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”."

**êµ¬ì¡° ê°€ì´ë“œ**
- 4-5ë¬¸ìž¥ (ì•½ 120-150ìž)
- ì¸ì‚¬ 1ë¬¸ìž¥ + í•µì‹¬ ì •ë³´/ë¦¬ì†ŒìŠ¤ 2-3ë¬¸ìž¥ + ì¶”ê°€ ì§€ì› ì œì•ˆ 1ë¬¸ìž¥
- ì´ëª¨ì§€ëŠ” ì‹œìž‘ ë¶€ë¶„ì— 1ê°œë§Œ
- ë§ˆí¬ë‹¤ìš´ ì œëª© ì‚¬ìš© ê¸ˆì§€
- êµ¬ì²´ì ì¸ ê²€ìƒ‰ì–´ë‚˜ í”Œëž«í¼ëª… í¬í•¨

ì‚¬ìš©ìžì—ê²Œ ì‹¤ì§ˆì  ê°€ì¹˜ë¥¼ ì œê³µí•˜ë˜, ê°„ê²°í•˜ê²Œ ì „ë‹¬í•˜ì„¸ìš”.`;

        console.log("[AI Resource Recommend] OpenAI ìš”ì²­ ì‹œìž‘");
        const completion = await openai.chat.completions.create({
            model: "gpt-5.1-2025-11-13",
            messages: [
                {
                    role: "system",
                    content: "ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ AI ë¹„ì„œìž…ë‹ˆë‹¤. ì‚¬ìš©ìžì—ê²Œ í•„ìš”í•œ í•µì‹¬ ì •ë³´ì™€ ì‹¤ì§ˆì ì¸ ë¦¬ì†ŒìŠ¤ë¥¼ ê°„ê²°í•˜ê²Œ ì œê³µí•˜ì„¸ìš”. ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ê³ , ê° í™œë™ì— ë§žëŠ” êµ¬ì²´ì ì¸ ê²€ìƒ‰ì–´, í”Œëž«í¼, ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì–¸ì„ ì œì‹œí•˜ì„¸ìš”. ìž¥í™©í•˜ì§€ ì•Šë˜ ê°€ì¹˜ ìžˆëŠ” ë‚´ìš©ì„ ë‹´ìœ¼ì„¸ìš”."
                },
                {
                    role: "user",
                    content: prompt,
                },
            ],
            temperature: 0.7,
        });

        console.log("[AI Resource Recommend] OpenAI ì‘ë‹µ ì„±ê³µ");
        const recommendation = completion.choices[0]?.message?.content || "ë¦¬ì†ŒìŠ¤ë¥¼ ì¶”ì²œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

        return NextResponse.json({
            recommendation,
            activity,
            category,
        });
    } catch (error: any) {
        console.error("[AI Resource Recommend] ì—ëŸ¬ ë°œìƒ:", error);
        console.error("[AI Resource Recommend] ì—ëŸ¬ ìƒì„¸:", error.message);
        console.error("[AI Resource Recommend] ì—ëŸ¬ ìŠ¤íƒ:", error.stack);
        return NextResponse.json(
            { error: "Failed to generate resource recommendation", details: error.message },
            { status: 500 }
        );
    }
}
