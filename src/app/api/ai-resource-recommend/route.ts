import { NextRequest, NextResponse } from "next/server";
import { auth } from "@/auth";
import OpenAI from "openai";

const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(request: NextRequest) {
    try {
        console.log("[AI Resource Recommend] API í˜¸ì¶œ ì‹œìž‘");

        // Check authentication
        const session = await auth();
        if (!session?.user?.email) {
            console.error("[AI Resource Recommend] Unauthorized access attempt");
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        const { activity, category } = await request.json();
        console.log("[AI Resource Recommend] ìš”ì²­ ë°ì´í„°:", { activity, category });

        if (!activity) {
            return NextResponse.json(
                { error: "Activity is required" },
                { status: 400 }
            );
        }

        // Get current context for personalized messages
        const now = new Date();
        const hour = now.getHours();
        const currentSeason = now.getMonth() >= 11 || now.getMonth() <= 1 ? "ê²¨ìš¸" :
                             now.getMonth() >= 2 && now.getMonth() <= 4 ? "ë´„" :
                             now.getMonth() >= 5 && now.getMonth() <= 7 ? "ì—¬ë¦„" : "ê°€ì„";
        const timeOfDay = hour < 12 ? "ì˜¤ì „" : hour < 18 ? "ì˜¤í›„" : "ì €ë…";

        // Generate professional assistant messages with value
        const prompt = `ì‚¬ìš©ìžê°€ "${activity}" ì¼ì •ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.

í˜„ìž¬ ìƒí™©:
- ì‹œê°„ëŒ€: ${timeOfDay} ${hour}ì‹œ
- ê³„ì ˆ: ${currentSeason}
- í™œë™ ì¹´í…Œê³ ë¦¬: ${category}

ì „ë¬¸ AI ë¹„ì„œë¡œì„œ ë‹¤ìŒ ì›ì¹™ì— ë”°ë¼ ë©”ì‹œì§€ë¥¼ ìž‘ì„±í•˜ì„¸ìš”:

**í•µì‹¬ ì›ì¹™**
- ì¡´ëŒ“ë§ë§Œ ì‚¬ìš© (ë°˜ë§ ì ˆëŒ€ ê¸ˆì§€)
- í•„ìš”í•œ ì •ë³´ë§Œ ì •í™•í•˜ê²Œ ì „ë‹¬
- ì‹¤ì§ˆì ì¸ ë„ì›€ì´ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ë‚˜ í–‰ë™ ì œì‹œ
- ê° í™œë™ë§ˆë‹¤ ì™„ì „ížˆ ë‹¤ë¥¸ ì ‘ê·¼ ë°©ì‹

**í™œë™ë³„ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼**

ðŸ“š **ë…ì„œ/í•™ìŠµ** - ë¦¬ì†ŒìŠ¤ ì œê³µ ì¤‘ì‹¬
ì˜ˆ: "ë…ì„œ ì¼ì •ì„ ì¶”ê°€í•˜ì…¨ë„¤ìš” ðŸ“š

ì¶”ì²œ ë¦¬ì†ŒìŠ¤:
â€¢ êµë³´ë¬¸ê³  eBook - 'ë¦° ìŠ¤íƒ€íŠ¸ì—…' ê²€ìƒ‰í•˜ì‹œë©´ MVP ê°œë…ì„ ìž˜ ì„¤ëª…í•œ ì±…ì„ ì°¾ìœ¼ì‹¤ ìˆ˜ ìžˆì–´ìš”
â€¢ YES24 - ì°½ì—…/ë¹„ì¦ˆë‹ˆìŠ¤ ì¹´í…Œê³ ë¦¬ì—ì„œ ë² ìŠ¤íŠ¸ì…€ëŸ¬ í™•ì¸
â€¢ ë°€ë¦¬ì˜ ì„œìž¬ - ì›” ì •ì•¡ìœ¼ë¡œ ë‹¤ì–‘í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ì„œì  ë¬´ì œí•œ ë…ì„œ
â€¢ ìœ íŠœë¸Œ 'ë¶ë¦¬ë·°' ì±„ë„ - ì±… ìš”ì•½ ì˜ìƒìœ¼ë¡œ ë¯¸ë¦¬ ë‚´ìš© íŒŒì•…

íš¨ê³¼ì ì¸ ë…ì„œ íŒ:
1. ë©”ëª¨ ì•±ì„ ì—´ì–´ë‘ê³  í•µì‹¬ ë‚´ìš©ì„ ë°”ë¡œ ì •ë¦¬í•˜ì„¸ìš”
2. í•œ ì±•í„°ì”© ì½ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ì•„ì´í…œ 1ê°œì”© ë½‘ì•„ë³´ì„¸ìš”
3. íƒ€ì´ë¨¸ë¥¼ 25ë¶„ìœ¼ë¡œ ì„¤ì •í•˜ê³  ì§‘ì¤‘í•´ì„œ ì½ìœ¼ë©´ íš¨ìœ¨ì ì´ì—ìš”

ë‹¤ë¥¸ ì¶”ì²œ ë„ì„œë‚˜ í•™ìŠµ ìžë£Œê°€ í•„ìš”í•˜ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”!"

ðŸŽ§ **íŒŸìºìŠ¤íŠ¸/ì˜¤ë””ì˜¤** - ì¶”ì²œ í”„ë¡œê·¸ëž¨ + ì²­ì·¨ íŒ
ì˜ˆ: "ì°½ì—… ê´€ë ¨ íŒŸìºìŠ¤íŠ¸ ì¼ì •ì„ ì¶”ê°€í•˜ì…¨ë„¤ìš” ðŸŽ§

ì¶”ì²œ íŒŸìºìŠ¤íŠ¸:
â€¢ ì• í”Œ íŒŸìºìŠ¤íŠ¸/ìœ íŠœë¸Œ 'ìŠ¤íƒ€íŠ¸ì—… ì¸ì‚¬ì´íŠ¸' - êµ­ë‚´ ì°½ì—…ê°€ë“¤ì˜ ìƒìƒí•œ ê²½í—˜ë‹´
â€¢ 'How I Built This' (NPR) - ê¸€ë¡œë²Œ ê¸°ì—… ì°½ì—… ìŠ¤í† ë¦¬, ì˜ì–´ ë“£ê¸° ì—°ìŠµë„ ê°€ëŠ¥
â€¢ 'StartUp Podcast' - ì‹¤ì œ ì°½ì—… ê³¼ì •ì„ ë”°ë¼ê°€ëŠ” ì‹œë¦¬ì¦ˆ
â€¢ ë„¤ì´ë²„ ì˜¤ë””ì˜¤í´ë¦½ 'ì°½ì—… ì´ì•¼ê¸°' - ë‹¤ì–‘í•œ ì—…ì¢…ì˜ ì°½ì—… ì‚¬ë¡€

íš¨ê³¼ì ìœ¼ë¡œ ë“£ëŠ” íŒ:
1. ë…¸ì…˜ì´ë‚˜ ë©”ëª¨ ì•±ì„ ì¼œë‘ê³  í•µì‹¬ ì¸ì‚¬ì´íŠ¸ë¥¼ ë°”ë¡œ ê¸°ë¡í•˜ì„¸ìš”
2. 1.5ë°°ì†ìœ¼ë¡œ ë“¤ìœ¼ë©´ ì‹œê°„ì„ 30% ì ˆì•½í•  ìˆ˜ ìžˆì–´ìš”
3. ì¶œí‡´ê·¼ ì‹œê°„ì´ë‚˜ ì‚°ì±…/ìš´ë™ ì¤‘ì— ë“¤ìœ¼ë©´ ì‹œê°„ í™œìš©ì´ íš¨ìœ¨ì ì´ì—ìš”

ë“£ê³  ì‹¶ì€ íŠ¹ì • ì£¼ì œê°€ ìžˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”!"

ðŸ’¼ **íšŒì˜/ì—…ë¬´** - ì¤€ë¹„ ì²´í¬ + ì§€ì›
ì˜ˆ: "íšŒì˜ ì¼ì •ì„ ì¶”ê°€í•˜ì…¨ë„¤ìš” ðŸ’¼

ì¤€ë¹„ ì²´í¬ë¦¬ìŠ¤íŠ¸:
â€¢ ë°œí‘œ ìžë£Œ ìµœì¢… í™•ì¸ ë° ë°±ì—… ì €ìž¥
â€¢ ì°¸ê³  ë¬¸ì„œì™€ ë°ì´í„° ì •ë¦¬
â€¢ íšŒì˜ ì•„ì  ë‹¤ ìž¬ì ê²€
â€¢ ì§ˆë¬¸ ì˜ˆìƒ ë‹µë³€ ì¤€ë¹„

íšŒì˜ íš¨ìœ¨ì„ ë†’ì´ëŠ” íŒ:
1. ë…¸ì…˜ì´ë‚˜ êµ¬ê¸€ ë…ìŠ¤ë¡œ ì‹¤ì‹œê°„ íšŒì˜ë¡ ìž‘ì„±
2. í•µì‹¬ ë©”ì‹œì§€ 3ê°€ì§€ë§Œ ì§‘ì¤‘í•´ì„œ ì „ë‹¬
3. íƒ€ì´ë¨¸ë¡œ ê° ì•ˆê±´ë³„ ì‹œê°„ ê´€ë¦¬

íšŒì˜ ì£¼ì œ ê´€ë ¨ ì¶”ê°€ ìžë£Œê°€ í•„ìš”í•˜ì‹œë©´ êµ¬ì²´ì ì¸ ë‚´ìš©ì„ ì•Œë ¤ì£¼ì„¸ìš”."

ðŸš€ **í”„ë¡œì íŠ¸/ì½”ë”©** - ì‹¤ìš© ë¦¬ì†ŒìŠ¤ + ì¡°ì–¸
ì˜ˆ: "AI MVP ê°œë°œ ì¼ì •ì„ ì¶”ê°€í•˜ì…¨ë„¤ìš” ðŸš€ GitHubì—ì„œ 'ai mvp boilerplate'ë‚˜ 'fastapi langchain'ìœ¼ë¡œ ê²€ìƒ‰í•˜ì‹œë©´ ì°¸ê³ í•  í…œí”Œë¦¿ë“¤ì´ ë§Žì•„ìš”. í•µì‹¬ ê¸°ëŠ¥ í•˜ë‚˜ë§Œ ë¨¼ì € ì™„ì„±í•˜ì‹œê³  í™•ìž¥í•˜ì‹œê¸¸ ì¶”ì²œë“œë ¤ìš”."

ðŸ’ª **ìš´ë™** - ì‹¤ìš© íŒ + ë¦¬ì†ŒìŠ¤
ì˜ˆ: "ìš´ë™ ì¼ì •ì„ ì¶”ê°€í•˜ì…¨ë„¤ìš” ðŸ’ª ê²¨ìš¸ì´ë‹ˆ ì¶©ë¶„ížˆ ì›Œë°ì—…í•˜ì„¸ìš”. ìœ íŠœë¸Œì—ì„œ 'ì´ˆë³´ í™ˆíŠ¸ë ˆì´ë‹'ì„ ê²€ìƒ‰í•˜ì‹œë©´ ë”°ë¼í•˜ê¸° ì¢‹ì€ ë£¨í‹´ì„ ì°¾ìœ¼ì‹¤ ìˆ˜ ìžˆì–´ìš”."

â˜• **íœ´ì‹/ì‚¬êµ** - ìž¥ì†Œ/í™˜ê²½ ì œì•ˆ ì¤‘ì‹¬
ì˜ˆ: "ì»¤í”¼ì±— ì¼ì •ì„ ì¶”ê°€í•˜ì…¨ë„¤ìš” â˜• ë„¤ì´ë²„ ì§€ë„ì—ì„œ 'ì¡°ìš©í•œ ì¹´íŽ˜'ë¡œ ê²€ìƒ‰í•˜ì‹œë©´ ëŒ€í™”í•˜ê¸° ì¢‹ì€ ê³³ë“¤ì´ ë‚˜ì™€ìš”. ë¯¸ë¦¬ ëŒ€í™” ì£¼ì œë¥¼ ì •í•´ë‘ì‹œë©´ ë” ì•Œì°¬ ì‹œê°„ì´ ë  ê±°ì˜ˆìš”."

ðŸ½ï¸ **ì‹ì‚¬** - ë©”ë‰´ ì œì•ˆ + ìž¥ì†Œ
ì˜ˆ: "ì ì‹¬ ì‹ì‚¬ ì¼ì •ì„ ì¶”ê°€í•˜ì…¨ë„¤ìš” ðŸ½ï¸ ì˜¤í›„ì—ëŠ” ë‹¨ë°±ì§ˆì´ í’ë¶€í•œ ë©”ë‰´ê°€ ì¢‹ì•„ìš”. ë„¤ì´ë²„ ì§€ë„ì—ì„œ 'ì£¼ë³€ ìƒëŸ¬ë“œ ë³¼'ì´ë‚˜ 'ë‹­ê°€ìŠ´ì‚´ ë„ì‹œë½'ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”."

**êµ¬ì¡° ê°€ì´ë“œ**
- 8-12ë¬¸ìž¥ (ì•½ 300-400ìž) - ì¶©ë¶„í•œ ì •ë³´ ì œê³µ
- êµ¬ì„±:
  1. ì¸ì‚¬ ë° í™•ì¸ (1ë¬¸ìž¥)
  2. ì¶”ì²œ ë¦¬ì†ŒìŠ¤ (3-5ê°œ, êµ¬ì²´ì  ì´ë¦„/ë§í¬/ê²€ìƒ‰ì–´ í¬í•¨)
  3. íš¨ê³¼ì ì¸ ì‹¤í–‰ íŒ (2-3ê°€ì§€)
  4. ì£¼ì˜ì‚¬í•­ ë˜ëŠ” ì¶”ê°€ ë„ì›€ ì œì•ˆ (1ë¬¸ìž¥)
- ì´ëª¨ì§€ëŠ” ê° ì„¹ì…˜ë§ˆë‹¤ 1ê°œì”© ì‚¬ìš© (ì´ 2-3ê°œ)
- ë§ˆí¬ë‹¤ìš´ ì œëª©(#) ì‚¬ìš© ê¸ˆì§€í•˜ë˜, **ë³¼ë“œ**ë‚˜ â€¢ ë¦¬ìŠ¤íŠ¸ëŠ” í™œìš©
- ë°˜ë“œì‹œ êµ¬ì²´ì ì¸ í”Œëž«í¼ëª…, ê²€ìƒ‰ì–´, ë¦¬ì†ŒìŠ¤ ì´ë¦„ í¬í•¨

**í•„ìˆ˜ í¬í•¨ ìš”ì†Œ**
- ì¶”ì²œ ë¦¬ì†ŒìŠ¤: ìµœì†Œ 3ê°œ ì´ìƒì˜ êµ¬ì²´ì ì¸ í”Œëž«í¼/ì„œë¹„ìŠ¤/ë„êµ¬ ì´ë¦„
- ì‹¤í–‰ íŒ: ì‹¤ì œë¡œ í™œë™ì„ ë” íš¨ê³¼ì ìœ¼ë¡œ í•  ìˆ˜ ìžˆëŠ” êµ¬ì²´ì  ë°©ë²•
- ê²€ìƒ‰ í‚¤ì›Œë“œ: ì‚¬ìš©ìžê°€ ë°”ë¡œ ê²€ìƒ‰í•  ìˆ˜ ìžˆëŠ” í‚¤ì›Œë“œ ì œê³µ

ì‚¬ìš©ìžì—ê²Œ ì‹¤ì§ˆì ì´ê³  í’ë¶€í•œ ê°€ì¹˜ë¥¼ ì œê³µí•˜ì„¸ìš”. ê°„ê²°í•˜ë˜ ì¶©ë¶„í•œ ì •ë³´ë¥¼ ë‹´ìœ¼ì„¸ìš”.`;

        console.log("[AI Resource Recommend] OpenAI ìš”ì²­ ì‹œìž‘");
        const completion = await openai.chat.completions.create({
            model: "gpt-5.1-2025-11-13",
            messages: [
                {
                    role: "system",
                    content: "ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ AI ë¹„ì„œìž…ë‹ˆë‹¤. ì‚¬ìš©ìžì—ê²Œ í•„ìš”í•œ í•µì‹¬ ì •ë³´ì™€ ì‹¤ì§ˆì ì¸ ë¦¬ì†ŒìŠ¤ë¥¼ ê°„ê²°í•˜ê²Œ ì œê³µí•˜ì„¸ìš”. ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ê³ , ê° í™œë™ì— ë§žëŠ” êµ¬ì²´ì ì¸ ê²€ìƒ‰ì–´, í”Œëž«í¼, ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì–¸ì„ ì œì‹œí•˜ì„¸ìš”. ìž¥í™©í•˜ì§€ ì•Šë˜ ê°€ì¹˜ ìžˆëŠ” ë‚´ìš©ì„ ë‹´ìœ¼ì„¸ìš”."
                },
                {
                    role: "user",
                    content: prompt,
                },
            ],
            temperature: 0.7,
        });

        console.log("[AI Resource Recommend] OpenAI ì‘ë‹µ ì„±ê³µ");
        const recommendation = completion.choices[0]?.message?.content || "ë¦¬ì†ŒìŠ¤ë¥¼ ì¶”ì²œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

        return NextResponse.json({
            recommendation,
            activity,
            category,
        });
    } catch (error: any) {
        console.error("[AI Resource Recommend] ì—ëŸ¬ ë°œìƒ:", error);
        console.error("[AI Resource Recommend] ì—ëŸ¬ ìƒì„¸:", error.message);
        console.error("[AI Resource Recommend] ì—ëŸ¬ ìŠ¤íƒ:", error.stack);
        return NextResponse.json(
            { error: "Failed to generate resource recommendation", details: error.message },
            { status: 500 }
        );
    }
}
