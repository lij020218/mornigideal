import { NextRequest, NextResponse } from "next/server";
import { auth } from "@/auth";
import OpenAI from "openai";

const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(request: NextRequest) {
    try {
        console.log("[AI Resource Recommend] API í˜¸ì¶œ ì‹œìž‘");

        // Check authentication
        const session = await auth();
        if (!session?.user?.email) {
            console.error("[AI Resource Recommend] Unauthorized access attempt");
            return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
        }

        const { activity, category, context, timeUntil, activityName, userProfile } = await request.json();
        console.log("[AI Resource Recommend] ìš”ì²­ ë°ì´í„°:", { activity, category, context, timeUntil, activityName });

        // activityName is used for schedule_start context
        const targetActivity = activityName || activity;

        if (!targetActivity) {
            return NextResponse.json(
                { error: "Activity is required" },
                { status: 400 }
            );
        }

        // ì‚¬ìš©ìž í”„ë¡œí•„ ì •ë³´
        let userContext = "";
        if (userProfile) {
            userContext = `
ì‚¬ìš©ìž ì •ë³´:
- ì§ì—…: ${userProfile.job || 'ë¯¸ì„¤ì •'}
- ëª©í‘œ: ${userProfile.goal || 'ë¯¸ì„¤ì •'}
- ë ˆë²¨: ${userProfile.level || 'intermediate'}
- ê´€ì‹¬ì‚¬: ${(userProfile.interests || []).join(', ') || 'ë¯¸ì„¤ì •'}
`;
        }

        // Get current context for personalized messages
        const now = new Date();
        const hour = now.getHours();
        const currentSeason = now.getMonth() >= 11 || now.getMonth() <= 1 ? "ê²¨ìš¸" :
            now.getMonth() >= 2 && now.getMonth() <= 4 ? "ë´„" :
                now.getMonth() >= 5 && now.getMonth() <= 7 ? "ì—¬ë¦„" : "ê°€ì„";
        const timeOfDay = hour < 12 ? "ì˜¤ì „" : hour < 18 ? "ì˜¤í›„" : "ì €ë…";

        // Generate different prompts based on context
        let prompt = "";

        if (context === "upcoming_schedule") {
            // ë‹¤ê°€ì˜¤ëŠ” ì¼ì •ì— ëŒ€í•œ ì¤€ë¹„ ì¡°ì–¸
            prompt = `${userContext}
ì‚¬ìš©ìžì˜ ë‹¤ìŒ ì¼ì •ì¸ "${targetActivity}"ê¹Œì§€ ${timeUntil}ë¶„ ë‚¨ì•˜ìŠµë‹ˆë‹¤.
ì „ë¬¸ AI ë¹„ì„œë¡œì„œ ì‚¬ìš©ìžì˜ ì •ë³´ë¥¼ ê³ ë ¤í•˜ì—¬ 2-3ë¬¸ìž¥ì˜ ê°„ê²°í•˜ê³  êµ¬ì²´ì ì¸ ì¤€ë¹„ íŒì„ ì œê³µí•˜ì„¸ìš”. ì¡´ëŒ“ë§ê³¼ ì´ëª¨ì§€ 1ê°œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
ì˜ˆ: "ì˜í™” ê°ìƒ ì „ íŒì½˜ê³¼ ìŒë£Œë¥¼ ì¤€ë¹„í•˜ê³  ì¡°ëª…ì„ ì–´ë‘¡ê²Œ ì¡°ì ˆí•´ë³´ì„¸ìš” ðŸ¿ ì•Œë¦¼ì„ ë„ë©´ ë” ëª°ìž…í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤."`;
        } else if (context === "schedule_pre_reminder") {
            // ì¼ì • ì‹œìž‘ 10ë¶„ ì „ ì‚¬ì „ ì•Œë¦¼
            prompt = `${userContext}
ê³§ ì‚¬ìš©ìžì˜ "${targetActivity}" ì¼ì •ì´ ì‹œìž‘ë©ë‹ˆë‹¤.
ì‚¬ìš©ìžì˜ í”„ë¡œí•„ì„ ê³ ë ¤í•˜ì—¬, ì´ ì¼ì •ê³¼ ê´€ë ¨í•˜ì—¬ ì¤€ë¹„í•˜ê±°ë‚˜ ê²°ì •í•´ì•¼ í•  ì‚¬í•­ì„ ë¬»ëŠ” ë”°ëœ»í•˜ê³  êµ¬ì²´ì ì¸ ì§ˆë¬¸ì„ 1-2ë¬¸ìž¥ìœ¼ë¡œ ìž‘ì„±í•˜ì„¸ìš”. ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ì„¸ìš”.
ì˜ˆ: (ì˜í™” ê°ìƒ) "ì–´ë–¤ ì˜í™”ë¥¼ ë³´ì‹¤ì§€ ê²°ì •í•˜ì…¨ë‚˜ìš”? ê¸°ë¶„ì— ë§žëŠ” ì˜í™”ë¥¼ ì¶”ì²œí•´ë“œë¦´ê¹Œìš”?"
ì˜ˆ: (íšŒì˜) "íšŒì˜ ìžë£ŒëŠ” ëª¨ë‘ ì¤€ë¹„ë˜ì…¨ë‚˜ìš”? ë¯¸ë¦¬ í™•ì¸í•  ì‚¬í•­ì´ ìžˆë‹¤ë©´ ë§ì”€í•´ì£¼ì„¸ìš”."
ì˜ˆ: (ë…ì„œ, ëª©í‘œê°€ 'ì˜ì–´ ê³µë¶€') "ì˜¤ëŠ˜ì€ ì˜ì–´ ì›ì„œë¥¼ ì½ì–´ë³´ì‹œëŠ” ê±´ ì–´ë– ì„¸ìš”? ì¶”ì²œí•´ë“œë¦´ê¹Œìš”?"`;
        } else if (context === "schedule_completed") {
            // ì¼ì • ì¢…ë£Œ í›„ ë§žì¶¤í˜• í”¼ë“œë°± ìš”ì²­
            prompt = `${userContext}
ì‚¬ìš©ìžê°€ "${targetActivity}" ì¼ì •ì„ ë§ˆì³¤ìŠµë‹ˆë‹¤.
ì‚¬ìš©ìžì˜ ëª©í‘œì™€ ê´€ì‹¬ì‚¬ë¥¼ ê³ ë ¤í•˜ì—¬, ì´ í™œë™ì— ëŒ€í•œ ë§žì¶¤í˜• í”¼ë“œë°± ì§ˆë¬¸ 2-3ê°œë¥¼ ë¦¬ìŠ¤íŠ¸(â€¢)ë¡œ ì œì•ˆí•˜ì„¸ìš”. ì¡´ëŒ“ë§ê³¼ ì´ëª¨ì§€ 1ê°œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
ì˜ˆ: "ë…ì„œëŠ” ì–´ë– ì…¨ë‚˜ìš”? ðŸ“š
â€¢ í¥ë¯¸ë¡œìš´ ì¸ì‚¬ì´íŠ¸ê°€ ìžˆì—ˆë‹¤ë©´ ë©”ëª¨í•´ë“œë¦´ê¹Œìš”?
â€¢ ë‹¤ìŒ ì½ì„ ì±…ì„ ì¶”ì²œí•´ë“œë¦´ê¹Œìš”?"`;
        } else if (context === "in_progress") {
            // T+30ë¶„: ì—…ë¬´ ì§„í–‰ ì¤‘ ì¸ì‚¬ì´íŠ¸ ì œê³µ
            prompt = `${userContext}
ì‚¬ìš©ìžê°€ "${targetActivity}" í™œë™ì„ ì‹œìž‘í•œ ì§€ 30ë¶„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤.

**ì—­í• : ì „ëžµì  ë©˜í† **
ì´ì œ ì§‘ì¤‘ ë°©í•´ ì—†ì´ ê°€ì¹˜ ìžˆëŠ” ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•  ì‹œì ìž…ë‹ˆë‹¤.

**í•µì‹¬ ì›ì¹™:**
1. **ëª©í‘œ ì—°ê²°**: ì‚¬ìš©ìžì˜ ëª©í‘œ("${userProfile?.goal}")ì™€ ê´€ì‹¬ì‚¬(${(userProfile?.interests || []).join(', ')})ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì–¸ê¸‰
2. **ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆ**: ì§€ê¸ˆ ë°”ë¡œ ì‹¤ì²œí•  ìˆ˜ ìžˆëŠ” êµ¬ì²´ì ì¸ í–‰ë™ 1-2ê°€ì§€
3. **ìžì—°ìŠ¤ëŸ¬ìš´ í†¤**: ê°•ìš”í•˜ì§€ ì•Šê³  ì œì•ˆí•˜ëŠ” ëŠë‚Œ
4. **ê°„ê²°í•¨**: 2-3ë¬¸ìž¥

**ì¢‹ì€ ì˜ˆì‹œ:**
- (ì—…ë¬´ ì‹œìž‘ + ëª©í‘œ: AI ìŠ¤íƒ€íŠ¸ì—…) "**AI ìŠ¤íƒ€íŠ¸ì—… ì¤€ë¹„**ì— ë„ì›€ë  ë§Œí•œ ìžë£Œê°€ ìžˆì–´ìš”! SKí•˜ì´ë‹‰ìŠ¤ì˜ ìµœì‹  HBM ë‰´ìŠ¤ë‚˜ ì—”ë¹„ë””ì•„ì˜ íŒŒíŠ¸ë„ˆì‹­ ì „ëžµì„ ì²´í¬í•´ë³´ì‹œë©´ ì–´ë–¨ê¹Œìš”? ðŸ’¡"
- (í•™ìŠµ + ëª©í‘œ: ì˜ì–´ ê³µë¶€) "**ì˜ì–´ ê³µë¶€** ëª©í‘œì— ë§žì¶°, ì§€ê¸ˆ ë³´ëŠ” ìžë£Œë¥¼ ì˜ì–´ë¡œë„ ì½ì–´ë³´ì‹œëŠ” ê±´ ì–´ë– ì„¸ìš”? ðŸ“š"
- (íšŒì˜ + ê´€ì‹¬ì‚¬: ë§ˆì¼€íŒ…) "íšŒì˜ ë‚´ìš©ì„ **ë§ˆì¼€íŒ… ì „ëžµ** ê´€ì ì—ì„œ ì •ë¦¬í•´ë‘ë©´ ë‚˜ì¤‘ì— ìœ ìš©í•  ê²ƒ ê°™ì•„ìš” âœï¸"

**ë‚˜ìœ ì˜ˆì‹œ:**
âŒ "ìž˜ í•˜ê³  ê³„ì‹œë„¤ìš”! í™”ì´íŒ…!" (ë„ˆë¬´ ì¼ë°˜ì )
âŒ "ì§€ê¸ˆê¹Œì§€ í•œ ë‚´ìš©ì„ ì •ë¦¬í•´ë³´ì„¸ìš”" (ì¶”ì¸¡ì„± ì§€ì‹œ)

**ì¤‘ìš”**: ëª©í‘œë‚˜ ê´€ì‹¬ì‚¬ë¥¼ **êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰**í•˜ê³ , ê·¸ì— ë§žëŠ” í–‰ë™ì„ ì œì•ˆí•˜ì„¸ìš”.`;
        } else if (context === "schedule_start") {
            // ì¼ì • ì‹œìž‘ ì‹œ ë¦¬ì†ŒìŠ¤ ì¶”ì²œ (ë” ì´ìƒ ì‚¬ìš© ì•ˆ í•¨ - ì¡°ìš©í•œ ì•Œë¦¼ìœ¼ë¡œ ëŒ€ì²´ë¨)
            prompt = `${userContext}
"${targetActivity}" ì‹œê°„ì´ ì‹œìž‘ë˜ì—ˆìŠµë‹ˆë‹¤.
ì‚¬ìš©ìžì˜ ì§ì—…, ëª©í‘œ, ë ˆë²¨, ê´€ì‹¬ì‚¬ë¥¼ ê³ ë ¤í•˜ì—¬ ì´ í™œë™ì„ íš¨ê³¼ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” êµ¬ì²´ì ì¸ ì¡°ì–¸ì´ë‚˜ ë¦¬ì†ŒìŠ¤ë¥¼ 2-3ë¬¸ìž¥ìœ¼ë¡œ ì œê³µí•˜ì„¸ìš”. ì¡´ëŒ“ë§ê³¼ ì´ëª¨ì§€ 1ê°œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.

**ì˜ˆì‹œ**:
- (ë…ì„œ + ëª©í‘œ: ì˜ì–´ê³µë¶€) "ì˜ì–´ ì›ì„œ ì½ê¸°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš” ðŸ“š 'í•´ë¦¬í¬í„°' ê°™ì€ ì¹œìˆ™í•œ ì´ì•¼ê¸°ë¶€í„° ì‹œìž‘í•˜ë©´ ë¶€ë‹´ì´ ì ìŠµë‹ˆë‹¤."
- (ì—…ë¬´ + ëª©í‘œ: ìƒì‚°ì„± í–¥ìƒ) "ë½€ëª¨ë„ë¡œ íƒ€ì´ë¨¸ë¥¼ ì„¤ì •í•˜ê³  25ë¶„ ì§‘ì¤‘ ìž‘ì—…ì„ ì‹œìž‘í•´ë³´ì„¸ìš” â° íœ´ëŒ€í°ì€ ì„œëžì— ë„£ì–´ë‘ì„¸ìš”."
- (ìš´ë™ + ë ˆë²¨: beginner) "ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆì¹­ìœ¼ë¡œ ëª¸ì„ í’€ê³  ì‹œìž‘í•˜ì„¸ìš” ðŸƒ ìœ íŠœë¸Œ 'íž™ìœ¼ëœ¸' ì±„ë„ì˜ ì´ˆë³´ìžìš© ë£¨í‹´ì„ ì¶”ì²œí•©ë‹ˆë‹¤."

**ì£¼ì˜**: ì‚¬ìš©ìž ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¼ë°˜ì ì¸ ì¡°ì–¸ì„ ì œê³µí•˜ë˜, ìžˆë‹¤ë©´ ë°˜ë“œì‹œ í™œìš©í•˜ì„¸ìš”.`;
        } else {
            // ê¸°ì¡´ ì¼ì • ì¶”ê°€ ì‹œ ë¦¬ì†ŒìŠ¤ ì¶”ì²œ (ê¸°ë³¸)
            prompt = `${userContext}
ì‚¬ìš©ìžê°€ "${targetActivity}" (${category}, ${timeOfDay} ${hour}ì‹œ) ì¼ì •ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.
ì „ë¬¸ AI ë¹„ì„œë¡œì„œ, ì‚¬ìš©ìž ì •ë³´ë¥¼ ê³ ë ¤í•˜ì—¬ ì´ í™œë™ì„ ë°”ë¡œ ì‹œìž‘í•˜ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” ì‹¤ì§ˆì ì¸ ì¡°ì–¸ì´ë‚˜ ë¦¬ì†ŒìŠ¤ë¥¼ ì œê³µí•˜ì„¸ìš”.

**ì§€ì¹¨**:
1. **ë§¥ë½ íŒŒì•…**: í™œë™ ì´ë¦„ì—ì„œ êµ¬ì²´ì ì¸ ì˜ë„ê°€ ë³´ì´ë©´(ì˜ˆ: "ì˜í™” ê°ìƒ") ê²€ìƒ‰ ë°©ë²•ë³´ë‹¤ëŠ” **ì‹¤ì œ ì½˜í…ì¸  ì¶”ì²œ**ì´ë‚˜ **ë¶„ìœ„ê¸° ì¡°ì„± íŒ**ì„ ì œê³µí•˜ì„¸ìš”.
2. **ê³¼ë„í•œ ê²€ìƒ‰ ì§€ì–‘**: ë‹¨ìˆœížˆ "ìœ íŠœë¸Œì— ~ ê²€ìƒ‰í•˜ì„¸ìš”"ë¼ê³  ë‚˜ì—´í•˜ê¸°ë³´ë‹¤, "ìœ íŠœë¸Œ 'ê¹€ì‹œì„ ' ì±„ë„ì˜ ìµœì‹  ë¦¬ë·°ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”"ì²˜ëŸ¼ êµ¬ì²´ì ìœ¼ë¡œ ì½• ì§‘ì–´ì£¼ì„¸ìš”.
3. **ê°„ê²°í•¨**: 3-5ê°œ ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹ ìˆ˜ ìžˆìŠµë‹ˆë‹¤. í™œë™ ì„±ê²©ì— ë§žì¶° ê°€ìž¥ í•„ìš”í•œ 1-2ê°€ì§€ë§Œ ìž„íŒ©íŠ¸ ìžˆê²Œ ì œì•ˆí•´ë„ ì¢‹ìŠµë‹ˆë‹¤.

**í•„ìˆ˜ í¬í•¨**:
- í™œë™ì„ ë” ì¦ê²ê²Œ ë§Œë“¤ "í•œ ë— ì°¨ì´" íŒ (ì˜ˆ: ì¡°ëª…, ê°„ì‹, ì¤€ë¹„ë¬¼)
- ê³ ë¯¼ ì‹œê°„ì„ ì¤„ì—¬ì¤„ êµ¬ì²´ì ì¸ ì‹œìž‘ì  (ì˜ˆ: ë„·í”Œë¦­ìŠ¤ Top 10 ë°”ë¡œê°€ê¸°, íŠ¹ì • ìœ íŠœë¸Œ ì±„ë„ëª…)`;
        }

        console.log("[AI Resource Recommend] OpenAI ìš”ì²­ ì‹œìž‘");
        const modelName = "gpt-5.1-2025-11-13";
        const completion = await openai.chat.completions.create({
            model: modelName,
            messages: [
                {
                    role: "system",
                    content: "ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ AI ë¹„ì„œìž…ë‹ˆë‹¤. ì‚¬ìš©ìžì—ê²Œ í•„ìš”í•œ í•µì‹¬ ì •ë³´ì™€ ì‹¤ì§ˆì ì¸ ë¦¬ì†ŒìŠ¤ë¥¼ ê°„ê²°í•˜ê²Œ ì œê³µí•˜ì„¸ìš”. ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ê³ , ê° í™œë™ì— ë§žëŠ” êµ¬ì²´ì ì¸ ê²€ìƒ‰ì–´, í”Œëž«í¼, ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì–¸ì„ ì œì‹œí•˜ì„¸ìš”. ìž¥í™©í•˜ì§€ ì•Šë˜ ê°€ì¹˜ ìžˆëŠ” ë‚´ìš©ì„ ë‹´ìœ¼ì„¸ìš”."
                },
                {
                    role: "user",
                    content: prompt,
                },
            ],
            temperature: 0.7,
        });

        console.log("[AI Resource Recommend] OpenAI ì‘ë‹µ ì„±ê³µ");
        const recommendation = completion.choices[0]?.message?.content || "ë¦¬ì†ŒìŠ¤ë¥¼ ì¶”ì²œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

        return NextResponse.json({
            recommendation,
            activity: targetActivity,
            category,
            context,
        });
    } catch (error: any) {
        console.error("[AI Resource Recommend] ì—ëŸ¬ ë°œìƒ:", error);
        console.error("[AI Resource Recommend] ì—ëŸ¬ ìƒì„¸:", error.message);
        console.error("[AI Resource Recommend] ì—ëŸ¬ ìŠ¤íƒ:", error.stack);
        return NextResponse.json(
            { error: "Failed to generate resource recommendation", details: error.message },
            { status: 500 }
        );
    }
}
