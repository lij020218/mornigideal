/**
 * ì½˜í…ì¸  ì•ˆì „ í•„í„°
 *
 * ì„±ì , ìì‚´/ìí•´, ì‚´ì¸/í­ë ¥, ë§ˆì•½, í˜ì˜¤ ë°œì–¸ ë“±
 * ìœ í•´ ì½˜í…ì¸ ë¥¼ ì‚¬ì „ ì°¨ë‹¨í•©ë‹ˆë‹¤.
 */

// ì¹´í…Œê³ ë¦¬ë³„ ê¸ˆì§€ í‚¤ì›Œë“œ íŒ¨í„´ (ì •ê·œì‹)
const BLOCKED_PATTERNS: { category: string; patterns: RegExp[]; response: string }[] = [
  {
    category: 'sexual',
    patterns: [
      /ì„¹ìŠ¤|ì„±ê´€ê³„|ì„±í–‰ìœ„|ì•¼ë™|í¬ë¥´ë…¸|ìŒë€|ììœ„|ì„±ì¸ë¬¼|ë…¸ì¶œ|ê°•ê°„|ì„±í­í–‰|ì„±ì¶”í–‰|ì„±ë§¤ë§¤|ë§¤ì¶˜|ì›ì¡°êµì œ/,
      /sex|porn|nude|hentai|nsfw/i,
    ],
    response: 'ì£„ì†¡í•©ë‹ˆë‹¤. í•´ë‹¹ ì£¼ì œì— ëŒ€í•´ì„œëŠ” ë„ì›€ì„ ë“œë¦´ ìˆ˜ ì—†ì–´ìš”. ë‹¤ë¥¸ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ ì£¼ì„¸ìš”.',
  },
  {
    category: 'self_harm',
    patterns: [
      /ìì‚´|ìí•´|ëª©ë§¤|íˆ¬ì‹ |ê·¹ë‹¨ì \s*ì„ íƒ|ì£½ê³ \s*ì‹¶|ì£½ì„\s*ê±°|ì£½ì—¬\s*ì¤˜|ì‚´ê³ \s*ì‹¶ì§€\s*ì•Š/,
      /suicide|self.?harm|kill\s*myself/i,
    ],
    response: 'í˜ë“  ì‹œê°„ì„ ë³´ë‚´ê³  ê³„ì‹ ë‹¤ë©´, ì „ë¬¸ ìƒë‹´ì„ ë°›ì•„ë³´ì‹œê¸¸ ê¶Œí•©ë‹ˆë‹¤.\n\nğŸ“ ìì‚´ì˜ˆë°©ìƒë‹´ì „í™”: 1393\nğŸ“ ì •ì‹ ê±´ê°•ìœ„ê¸°ìƒë‹´ì „í™”: 1577-0199\n\nì „ë¬¸ê°€ê°€ 24ì‹œê°„ ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆì–´ìš”.',
  },
  {
    category: 'violence',
    patterns: [
      /ì‚´ì¸|ì‚´í•´|ì£½ì´|ì¹¼ë¶€ë¦¼|ì´ê¸°|í­íƒ„|í…ŒëŸ¬|ë°©í™”|í­í–‰\s*ë°©ë²•|ë‚©ì¹˜|ê°ê¸ˆ|ê³ ë¬¸/,
      /murder|kill\s*someone|how\s*to\s*make\s*a?\s*bomb|terrorism/i,
    ],
    response: 'ì£„ì†¡í•©ë‹ˆë‹¤. í­ë ¥ì´ë‚˜ ìœ„í•´ì™€ ê´€ë ¨ëœ ë‚´ìš©ì—ëŠ” ë„ì›€ì„ ë“œë¦´ ìˆ˜ ì—†ì–´ìš”. ë‹¤ë¥¸ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ ì£¼ì„¸ìš”.',
  },
  {
    category: 'drugs',
    patterns: [
      /ë§ˆì•½|í•„ë¡œí°|ëŒ€ë§ˆ|ì½”ì¹´ì¸|í—¤ë¡œì¸|ë©”ìŠ¤ì•”í˜íƒ€ë¯¼|í™˜ê°ì œ|ë³¸ë“œ\s*í¡ì…|ì•½ë¬¼\s*ë‚¨ìš©|íˆ¬ì•½\s*ë°©ë²•/,
      /how\s*to\s*(?:make|cook|buy)\s*(?:meth|cocaine|heroin|drugs)/i,
    ],
    response: 'ì£„ì†¡í•©ë‹ˆë‹¤. ë¶ˆë²• ì•½ë¬¼ ê´€ë ¨ ë‚´ìš©ì—ëŠ” ë„ì›€ì„ ë“œë¦´ ìˆ˜ ì—†ì–´ìš”. ë‹¤ë¥¸ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ ì£¼ì„¸ìš”.',
  },
  {
    category: 'hate',
    patterns: [
      /í˜ì˜¤\s*ë°œì–¸|ì¸ì¢…\s*ì°¨ë³„|ì„±ì°¨ë³„|ì¥ì• ì¸\s*ë¹„í•˜|í•™êµ\s*í­ë ¥\s*ë°©ë²•/,
    ],
    response: 'ì£„ì†¡í•©ë‹ˆë‹¤. ì°¨ë³„ì´ë‚˜ í˜ì˜¤ì™€ ê´€ë ¨ëœ ë‚´ìš©ì—ëŠ” ë„ì›€ì„ ë“œë¦´ ìˆ˜ ì—†ì–´ìš”. ë‹¤ë¥¸ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ ì£¼ì„¸ìš”.',
  },
];

export interface SafetyCheckResult {
  blocked: boolean;
  category?: string;
  response?: string;
}

/**
 * ì‚¬ìš©ì ì…ë ¥ ë©”ì‹œì§€ì˜ ì•ˆì „ì„±ì„ ê²€ì‚¬í•©ë‹ˆë‹¤.
 * ìœ í•´ ì½˜í…ì¸ ê°€ ê°ì§€ë˜ë©´ ì°¨ë‹¨ ì‘ë‹µì„ ë°˜í™˜í•©ë‹ˆë‹¤.
 */
export function checkContentSafety(message: string): SafetyCheckResult {
  if (!message || message.trim().length === 0) {
    return { blocked: false };
  }

  const normalized = message.toLowerCase().replace(/\s+/g, ' ').trim();

  for (const rule of BLOCKED_PATTERNS) {
    for (const pattern of rule.patterns) {
      if (pattern.test(normalized)) {
        return {
          blocked: true,
          category: rule.category,
          response: rule.response,
        };
      }
    }
  }

  return { blocked: false };
}

/**
 * AI ì‘ë‹µì˜ ì•ˆì „ì„±ì„ ê²€ì‚¬í•©ë‹ˆë‹¤.
 * OpenAIê°€ content_policyë¡œ ê±°ì ˆí•œ ê²½ìš°ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 */
export function checkResponseSafety(finishReason: string | null | undefined): SafetyCheckResult {
  if (finishReason === 'content_filter' || finishReason === 'content_policy') {
    return {
      blocked: true,
      category: 'content_policy',
      response: 'ì£„ì†¡í•©ë‹ˆë‹¤. í•´ë‹¹ ë‚´ìš©ì— ëŒ€í•´ì„œëŠ” ë‹µë³€ì„ ë“œë¦´ ìˆ˜ ì—†ì–´ìš”. ë‹¤ë¥¸ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ ì£¼ì„¸ìš”.',
    };
  }
  return { blocked: false };
}

/**
 * System Promptì— ì¶”ê°€í•  ì•ˆì „ ê·œì¹™ ë¸”ë¡
 */
export const SAFETY_SYSTEM_RULES = `
## ì ˆëŒ€ ê¸ˆì§€ ê·œì¹™ (ìœ„ë°˜ ì‹œ ì¦‰ì‹œ ê±°ì ˆ)
- ì„±ì ì´ê±°ë‚˜ ìŒë€í•œ ì½˜í…ì¸  ìƒì„±/ì œì•ˆ ì ˆëŒ€ ê¸ˆì§€
- ìì‚´, ìí•´ ë°©ë²• ì•ˆë‚´ ì ˆëŒ€ ê¸ˆì§€ (ìœ„ê¸° ìƒë‹´ ë²ˆí˜¸ë§Œ ì•ˆë‚´)
- ì‚´ì¸, í­ë ¥, í…ŒëŸ¬ ë“± ìœ„í•´ í–‰ìœ„ ì¡°ì¥/ë°©ë²• ì•ˆë‚´ ì ˆëŒ€ ê¸ˆì§€
- ë¶ˆë²• ì•½ë¬¼ ì œì¡°/êµ¬ë§¤/ì‚¬ìš© ë°©ë²• ì•ˆë‚´ ì ˆëŒ€ ê¸ˆì§€
- ì¸ì¢…, ì„±ë³„, ì¥ì•  ë“±ì— ëŒ€í•œ ì°¨ë³„/í˜ì˜¤ ë°œì–¸ ì ˆëŒ€ ê¸ˆì§€
- ê°œì¸ì •ë³´(ì£¼ë¯¼ë²ˆí˜¸, ì¹´ë“œë²ˆí˜¸ ë“±) ìš”ì²­/ìƒì„± ì ˆëŒ€ ê¸ˆì§€

ìœ„ ì£¼ì œ ìš”ì²­ ì‹œ: ì •ì¤‘í•˜ê²Œ ê±°ì ˆí•˜ê³  ì ì ˆí•œ ì „ë¬¸ ê¸°ê´€ì„ ì•ˆë‚´í•˜ì„¸ìš”.
`.trim();
